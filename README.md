# MIST: A Unified Approach to Medical Image Segmentation

This project implements a unified approach for medical image segmentation through mixed supervision, self-learning, and transfer learning (MIST). It includes two main programs:
1. **MIST**: For efficient 2D training label generation.
2. **3D nnU-Net**: A body composition model trained on the labels generated by MIST.

## Table of Contents

1. [Installation](#installation)
2. [Model Weights](#model-weights)
3. [Running the MIST Program](#running-the-mist-program)
4. [Running the 3D Body Composition Program](#running-the-3d-body-composition-program)
5. [Citing This Work](#citing-this-work)

## Installation

Follow these steps to set up the environment:

1. **Install the latest version of PyTorch** following the instructions on the [PyTorch website](https://pytorch.org/get-started/locally/).

2. **Install nnU-Net V2**:
   ```bash
   pip install nnunetv2
   ```

3. **Activate the virtual environment for MIST**:
   ```bash
   conda activate MIST_lib
   ```

## Model Weights

Download and unzip the model weights from the following link:
- [Model Weights](https://nihcc.box.com/s/rxbf6j9ouzdgk1znlv3zoh865t6owelx)

Save the model weights as follows:
- **2D Model**: `2D_MIST/trained_model`
- **3D Model**: `3D_body_composition/model_weights`

## Running the MIST Program

### 1. Prepare Training Data

Organize your training data in the following structure:

```
Training_data/
├── strong_labels/
│   ├── images/
│   │   ├── 00003_slice1.nii.gz
│   │   └── 00003_slice27.nii.gz
│   └── masks/
│       ├── 00003_slice1.nii.gz
│       └── 00003_slice27.nii.gz
└── weak_labels/
    ├── images/
    │   ├── 00003_slice2.nii.gz
    │   └── 00003_slice3.nii.gz
    └── masks/
        ├── 00003_slice2.nii.gz
        └── 00003_slice3.nii.gz
```

### 2. Train the 2D MIST Model

Run the following command to train the model:

```bash
python train.py -si Training_data/strong_labels -wi Training_data/weak_labels -c fat_seg_dual_branch -o model_file_fold
```

### 3. Inference on 3D CT Scans using 2D MIST model

Use the following commands for inference:

```bash
python test.py -d directory_with_input_CT_scans -o OUTPUT_FOLDER -m trained_models/checkpoint_best.py
```

Alternatively, you can specify a list of input files:

```bash
python test.py -i input_file_list.txt -o OUTPUT_FOLDER -m trained_models/checkpoint_best.py
```

Here, `input_file_list.txt` should contain paths to the CT files.

## Running the 3D Body Composition Program

To run the body composition model, use the following command structure:

```bash
usage: nnunet_predict.py [-h] [-i INPUT_DATA] [-o OUTPUT_DATA] [-m MODEL_DIRECTORY] [-v] [-f] [-d device]
```

### Example Commands:

1. Process a list of files:
   ```bash
   python nnunet_predict.py -i fn_fat_patients.txt -o res -d cuda -f
   ```

2. Process a single NIFTI file:
   ```bash
   python nnunet_predict.py -i ct_vol.nii.gz -o res -d cuda
   ```

3. Process all NIFTI files in a directory:
   ```bash
   python nnunet_predict.py -i fn_dir -o res -d cuda -f
   ```

4. Save segmentation results to a specific file:
   ```bash
   python nnunet_predict.py -i ct_vol.nii.gz -o ct_vol_seg.nii.gz -d cuda
   ```

5. Use a different model directory:
   ```bash
   python nnunet_predict.py -i ct_vol.nii.gz -o ct_vol_seg.nii.gz -m FOLD_to_save_another_FIVE_folds_model_files -d cuda
   ```

### Important Notes:
- The `model_weights` folder should contain `fold0`, `fold1`, etc.
- The program attempts to create file links first; it will fall back to file copy if linking fails.
- The use of this software is subject to the Terms of Use document in this repository.

## Citing This Work

If you use this code, please cite the following paper:

> Jianfei Liu, Sayantan Bhadra, Omid Shafaat, Pritam Mukherjee, Christopher Parnell, Ronald M. Summers, "A unified approach to medical image segmentation by leveraging mixed supervision and self and transfer learning," *Computerized Medical Imaging and Graphics*, vol. 122, pp. 102517, 2025. 

---

For any issues or contributions, please open an issue or pull request on this repository. Happy coding!# NIH_CADLab_Body_Composition
